# å·¥ä½œæµç¨‹åç§°
name: ä½¿ç”¨ pnpm æ„å»ºå¹¶éƒ¨ç½² VuePress ç«™ç‚¹åˆ° pages åˆ†æ”¯

# è§¦å‘å·¥ä½œæµç¨‹çš„äº‹ä»¶
on:
  push:
    branches:
      - main # ç›‘å¬ main åˆ†æ”¯çš„ push äº‹ä»¶ï¼Œä½ å¯ä»¥ä¿®æ”¹ä¸ºä½ çš„ä¸»åˆ†æ”¯åï¼Œä¾‹å¦‚ master

# å®šä¹‰ä¸€ä¸ªæˆ–å¤šä¸ªä½œä¸š (jobs)
jobs:
  # ä½œä¸šIDï¼Œå¯ä»¥è‡ªå®šä¹‰
  build-and-deploy:
    # ä½œä¸šåç§°ï¼Œæ˜¾ç¤ºåœ¨ GitHub Actions UI ä¸­
    name: æ„å»ºå¹¶éƒ¨ç½²åˆ° pages åˆ†æ”¯
    # ä½œä¸šè¿è¡Œçš„ç¯å¢ƒ
    runs-on: ubuntu-latest
    # ä¸ºä½œä¸šè®¾ç½®æƒé™
    permissions:
      contents: write # æˆäºˆå†™å…¥ä»“åº“å†…å®¹çš„æƒé™ï¼Œç”¨äº peaceiris/actions-gh-pages æ¨é€åˆ†æ”¯

    # ä½œä¸šä¸­çš„æ­¥éª¤
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“ ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰ Git æäº¤å†å²ï¼Œvuepress-theme-plume æˆ–å…¶æ’ä»¶å¯èƒ½éœ€è¦

      - name: è®¾ç½® Node.js ç¯å¢ƒ âš™ï¸
        uses: actions/setup-node@v4
        with:
          node-version: '20' # æŒ‡å®šä½ é¡¹ç›®æ‰€éœ€çš„ Node.js ç‰ˆæœ¬, ä¾‹å¦‚ 18, 20
          # pnpm çš„ç¼“å­˜å°†ç”± pnpm/action-setup å’Œ actions/cache é…åˆå¤„ç†

      - name: å®‰è£…ä¸è®¾ç½® pnpm ğŸ› ï¸
        uses: pnpm/action-setup@v3 # ä½¿ç”¨å®˜æ–¹çš„ pnpm-setup action
        with:
          version: 8 # æŒ‡å®š pnpm ç‰ˆæœ¬ï¼Œæˆ–ç§»é™¤æ­¤è¡Œä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆ
          run_install: false # æˆ‘ä»¬å°†åœ¨åç»­æ­¥éª¤ä¸­æ‰‹åŠ¨è¿è¡Œå®‰è£…å‘½ä»¤

      - name: è·å– pnpm å­˜å‚¨ç›®å½•è·¯å¾„ ğŸ“‚
        id: pnpm-cache # ç»™è¿™ä¸ªæ­¥éª¤è®¾ç½®ä¸€ä¸ªIDï¼Œæ–¹ä¾¿åç»­å¼•ç”¨å…¶è¾“å‡º
        shell: bash # ä½¿ç”¨ bash shell æ‰§è¡Œå‘½ä»¤
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT # è·å– pnpm store è·¯å¾„å¹¶è®¾ä¸ºè¾“å‡ºå˜é‡

      - name: è®¾ç½® pnpm ç¼“å­˜ âš¡
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }} # ç¼“å­˜ pnpm store ç›®å½•
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }} # ç¼“å­˜çš„å”¯ä¸€é”®
          restore-keys: | # å¦‚æœç²¾ç¡®é”®æœªæ‰¾åˆ°ï¼Œå°è¯•æ¢å¤çš„å¤‡ç”¨é”®
            ${{ runner.os }}-pnpm-store-

      - name: ä½¿ç”¨ pnpm å®‰è£…é¡¹ç›®ä¾èµ– ğŸ“¦
        run: pnpm install --frozen-lockfile # --frozen-lockfile ç¡®ä¿ä½¿ç”¨ lock æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬ï¼Œä¿è¯æ„å»ºä¸€è‡´æ€§

      - name: æ„å»º VuePress ç«™ç‚¹ ğŸ—ï¸
        run: pnpm run docs:build # è¿è¡Œ package.json ä¸­å®šä¹‰çš„æ„å»ºè„šæœ¬
                                 # ä¾‹å¦‚: pnpm run build, å…·ä½“å‘½ä»¤è¯·æŸ¥çœ‹ä½ çš„ package.json

      - name: éƒ¨ç½²åˆ° "pages" åˆ†æ”¯ ğŸš€
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }} # GitHub è‡ªåŠ¨æä¾›çš„ä»¤ç‰Œï¼Œç”¨äºè®¤è¯
          publish_dir: docs/.vuepress/dist # VuePress æ„å»ºè¾“å‡ºçš„é™æ€æ–‡ä»¶ç›®å½•
                                           # è¯·æ ¹æ®ä½ çš„é¡¹ç›®å®é™…è¾“å‡ºç›®å½•è°ƒæ•´
                                           # VuePress 1.x é€šå¸¸æ˜¯: docs/.vuepress/dist
                                           # VuePress 2.x é€šå¸¸ä¹Ÿæ˜¯: docs/.vuepress/dist (å¯åœ¨é…ç½®ä¸­ä¿®æ”¹)
          publish_branch: pages # æŒ‡å®šè¦å°†é™æ€æ–‡ä»¶æ¨é€åˆ°å“ªä¸ªåˆ†æ”¯ï¼Œè¿™é‡Œæ˜¯ "pages"
          user_name: 'github-actions[bot]' # å¯é€‰ï¼šè‡ªå®šä¹‰æäº¤éƒ¨ç½²çš„ç”¨æˆ·åç§°
          user_email: 'github-actions[bot]@users.noreply.github.com' # å¯é€‰ï¼šè‡ªå®šä¹‰æäº¤éƒ¨ç½²çš„ç”¨æˆ·é‚®ç®±
          # cname: example.com # å¯é€‰ï¼šå¦‚æœä½ ä½¿ç”¨è‡ªå®šä¹‰åŸŸåï¼Œå¯ä»¥åœ¨è¿™é‡ŒæŒ‡å®š